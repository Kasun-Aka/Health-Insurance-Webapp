<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Report - TureLife Health Insurance</title>
  <link rel="stylesheet" href="../CSS/AdminDashboard.css">
</head>
<body>
<!-- Header -->
<header class="header">
  <div class="nav-container">
    <div class="logo">
      <img src="../image/logo.png" class="logo-img">
      TrueLife Admin Dashboard
    </div>
    <div class="nav-buttons">
      <span class="welcome-text">Admin Dashboard</span>
      <button class="btn btn-outline" onclick="goToDashboard()">DASHBOARD</button>
      <button class="btn btn-primary" onclick="refreshData()">REFRESH</button>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="dashboard-main">
  <div class="dashboard-container">
    <!-- System Overview Stats -->
    <div class="stats-section">
      <h2>System Overview</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-content">
            <h3>Total Users</h3>
            <p id="userCount">-</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üí≥</div>
          <div class="stat-content">
            <h3>Total Payments</h3>
            <p id="paymentCount">-</p>
          </div>
        </div>
        <!-- div class="stat-card">
          <div class="stat-icon">üìã</div>
          <div class="stat-content">
            <h3>Filed Claims</h3>
            <p id="claimCount">-</p>
          </div>
        </div -->
        <div class="stat-card">
          <div class="stat-icon">üè•</div>
          <div class="stat-content">
            <h3>Insurance Plans</h3>
            <p id="planCount">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Data Actions -->
    <div class="actions-section">
      <h2>Export System Data</h2>
      <div class="actions-grid">
        <button class="action-card" onclick="window.location.href='report-dashboard.html'">
          <div class="action-icon">üìã</div>
          <h3>Analytics & Reports</h3>
          <p>Redirect to Analytics and Reports Management</p>
        </button>

        <button class="action-card" onclick="window.location.href='policy-admin.html'">
          <div class="action-icon">üè•</div>
          <h3>Create/Edit Policy Plans</h3>
          <p>Create/ Update/ Delete Insurance Policy Plans</p>
        </button>
      </div>
    </div>

    <!-- User Management Actions -->
    <div class="actions-section">
      <h2>User Management</h2>
      <div class="actions-grid">
        <button class="action-card delete-action" onclick="goToDeleteUsers()">
          <div class="action-icon">üóëÔ∏è</div>
          <h3>Delete Users</h3>
          <p>Manage and delete user accounts</p>
        </button>
      </div>

    </div>
  </div>
</main>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <p>Processing request...</p>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<script>
  // Configuration - Update these URLs to match your Spring Boot endpoints
  const API_BASE_URL = 'http://localhost:8080';

  const endpoints = {
    users: `${API_BASE_URL}/api/users`,
    payments: `${API_BASE_URL}/api/payments/view/all`,
    claims: `${API_BASE_URL}/file-claims`,
    plans: `${API_BASE_URL}/api/policies/active`
  };







  // SECURE ADMIN CONFIGURATION
  // Admin users with email and verification data
  const ADMIN_USERS = [
    {
      email: 'yenuli@gmail.com',     // Replace with YOUR actual email
      secretCode: 'ADMIN123',              // Your secret code
      name: 'Main Admin'                   // Your name
    },
    {
      email: 'admin@ceymed.com',
      secretCode: 'CEYMED2024',
      name: 'System Admin'
    }
    // Add more admins here with their own secret codes
  ];

  // SECURE ADMIN ACCESS CONTROL
  function checkAdminAccess() {
    // Check if already authenticated in this session
    const sessionAuth = sessionStorage.getItem('adminAuthenticated');
    const sessionEmail = sessionStorage.getItem('adminEmail');

    if (sessionAuth === 'true' && sessionEmail) {
      console.log('Admin session active for:', sessionEmail);
      showWelcomeMessage(sessionEmail);
      return true;
    }

    // Need to authenticate
    return performAdminLogin();
  }

  function performAdminLogin() {
    // Create login modal
    const modal = createLoginModal();
    document.body.appendChild(modal);

    return new Promise((resolve) => {
      window.adminLoginResolve = resolve;
    });
  }

  function createLoginModal() {
    const modal = document.createElement('div');
    modal.id = 'adminLoginModal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; justify-content: center;
        align-items: center; z-index: 10000; font-family: Arial, sans-serif;
    `;

    modal.innerHTML = `
        <div style="background: white; padding: 3rem; border-radius: 15px; max-width: 450px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="color: #f44336; margin-bottom: 0.5rem;">üîê Admin Login Required</h2>
                <p style="color: #666;">Enter your admin credentials to continue</p>
            </div>

            <form id="adminLoginForm" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: bold;">Admin Email:</label>
                    <input type="email" id="adminEmail" required
                           style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                           placeholder="Enter your admin email">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: bold;">Secret Code:</label>
                    <input type="password" id="adminCode" required
                           style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;"
                           placeholder="Enter your secret admin code">
                </div>

                <div id="loginError" style="color: #f44336; font-size: 0.9rem; display: none; text-align: center; margin-top: 0.5rem;">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" onclick="cancelAdminLogin()"
                            style="flex: 1; padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Cancel
                    </button>
                    <button type="submit"
                            style="flex: 1; padding: 0.75rem; background: linear-gradient(45deg, #f44336, #ef5350); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold;">
                        Login as Admin
                    </button>
                </div>
            </form>

            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; text-align: center;">
                <p style="font-size: 0.8rem; color: #999;">
                    Admin access is restricted. Contact system administrator if you need access.
                </p>
            </div>
        </div>
    `;

    // Add event listener for form submission
    setTimeout(() => {
      const form = document.getElementById('adminLoginForm');
      form.addEventListener('submit', handleAdminLogin);

      // Focus on email field
      document.getElementById('adminEmail').focus();
    }, 100);

    return modal;
  }

  function handleAdminLogin(event) {
    event.preventDefault();

    const email = document.getElementById('adminEmail').value.toLowerCase();
    const code = document.getElementById('adminCode').value;
    const errorDiv = document.getElementById('loginError');

    // Find admin user
    const adminUser = ADMIN_USERS.find(user =>
            user.email.toLowerCase() === email && user.secretCode === code
    );

    if (adminUser) {
      // Authentication successful
      sessionStorage.setItem('adminAuthenticated', 'true');
      sessionStorage.setItem('adminEmail', adminUser.email);
      sessionStorage.setItem('adminName', adminUser.name);

      // Remove login modal
      document.getElementById('adminLoginModal').remove();

      // Show welcome message
      showWelcomeMessage(adminUser.email, adminUser.name);

      // Resolve the promise to continue loading
      if (window.adminLoginResolve) {
        window.adminLoginResolve(true);
      }

      showToast('Admin login successful!', 'success');

    } else {
      // Authentication failed
      errorDiv.textContent = 'Invalid admin email or secret code. Access denied.';
      errorDiv.style.display = 'block';

      // Clear the password field
      document.getElementById('adminCode').value = '';
      document.getElementById('adminCode').focus();

      // Add shake animation to modal
      const modal = document.querySelector('#adminLoginModal > div');
      modal.style.animation = 'shake 0.5s';
      setTimeout(() => {
        modal.style.animation = '';
      }, 500);
    }
  }

  function cancelAdminLogin() {
    document.getElementById('adminLoginModal').remove();

    // Redirect to customer dashboard
    showAccessDenied('Admin login cancelled');

    if (window.adminLoginResolve) {
      window.adminLoginResolve(false);
    }
  }

  function showAccessDenied(message) {
    document.body.innerHTML = `
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; font-family: Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
            <div style="background: white; padding: 3rem; border-radius: 15px; text-align: center; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üö´</div>
                <h2 style="color: #f44336; margin-bottom: 1rem;">Access Denied</h2>
                <p style="color: #666; margin-bottom: 2rem; font-size: 1.1rem;">${message}</p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="window.location.href='index.html'"
                            style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Go to Home Page
                    </button>
                    <button onclick="window.location.reload()"
                            style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    `;
  }

  function showWelcomeMessage(email, name) {
    // Update the welcome text to show admin user
    const welcomeElement = document.querySelector('.welcome-text');
    if (welcomeElement) {
      welcomeElement.innerHTML = `Admin: ${name || email} <button onclick="logoutAdmin()" style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; cursor: pointer;">Logout</button>`;
      welcomeElement.style.color = '#f44336';
      welcomeElement.style.fontWeight = 'bold';
    }
  }

  function logoutAdmin() {
    sessionStorage.removeItem('adminAuthenticated');
    sessionStorage.removeItem('adminEmail');
    sessionStorage.removeItem('adminName');

    showToast('Admin logged out', 'info');
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }

  // Add shake animation CSS
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
        0%, 20%, 40%, 60%, 80% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    }
`;
  document.head.appendChild(style);

  // Initialize the page with secure admin check
  document.addEventListener('DOMContentLoaded', async function() {
    // Check admin access first
    const isAdmin = await checkAdminAccess();

    if (!isAdmin) {
      return; // Stop loading if authentication failed
    }

    // Load admin dashboard
    loadStatistics();
    showToast('Admin Dashboard loaded successfully!', 'info');
  });




  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    showToast('Admin Dashboard loaded successfully!', 'info');
  });

  // Load statistics from API
  async function loadStatistics() {
    showLoading(true);

    try {
      console.log('Loading statistics from APIs...');

      // Test each endpoint individually
      const users = await fetchDataWithDebug('users');
      const payments = await fetchDataWithDebug('payments');
      const claims = await fetchDataWithDebug('claims');
      const plans = await fetchDataWithDebug('plans');

      // Update stat cards with real data or fallback to mock data
      updateStatCard('userCount', users ? users.length : 0);
      updateStatCard('paymentCount', payments ? payments.length : 0);
      updateStatCard('claimCount', claims ? claims.length : 0);
      updateStatCard('planCount', plans ? plans.length : 0);

    } catch (error) {
      console.error('Error loading statistics:', error);
    } finally {
      showLoading(false);
    }
  }

  // Enhanced fetch with debugging
  async function fetchDataWithDebug(type) {
    const url = endpoints[type];
    console.log(`Fetching ${type} from: ${url}`);

    try {
      const response = await fetch(url);
      console.log(`${type} response status:`, response.status);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log(`${type} data received:`, data);

      // Handle different response formats
      let actualData;
      if (Array.isArray(data)) {
        actualData = data;
      } else if (data.data && Array.isArray(data.data)) {
        actualData = data.data;
      } else if (data.success && data.data) {
        actualData = Array.isArray(data.data) ? data.data : [data.data];
      } else {
        console.warn(`Unexpected data format for ${type}:`, data);
        actualData = [];
      }

      console.log(`${type} processed data:`, actualData);
      return actualData;

    } catch (error) {
      console.error(`Error fetching ${type}:`, error);
      return null;
    }
  }

  // Update stat card with animation
  function updateStatCard(elementId, value) {
    const element = document.getElementById(elementId);
    const targetValue = parseInt(value) || 0;
    let currentValue = 0;
    const increment = Math.max(1, Math.ceil(targetValue / 30)); // Animation duration

    const timer = setInterval(() => {
      currentValue += increment;
      if (currentValue >= targetValue) {
        currentValue = targetValue;
        clearInterval(timer);
      }
      element.textContent = currentValue.toLocaleString();
    }, 50);
  }

  // Navigation functions
  function goToDashboard() {
    showToast('Redirecting to main dashboard...', 'info');
    window.location.href = '../Dashboard/Dashboard.html';
  }

  function goToDeleteUsers() {
    showToast('Redirecting to user management...', 'info');
    window.location.href = 'DeleteUsers.html';
  }

  function goToReport() {
    showToast('Redirecting to Report management...', 'info');
    window.location.href = 'report-dashboard.html';
  }
  function refreshData() {
    showToast('Refreshing system data...', 'info');
    loadStatistics();
  }

  // Utility functions
  function formatDate(dateString) {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      return isNaN(date.getTime()) ? '' : date.toLocaleString();
    } catch (error) {
      return String(dateString);
    }
  }

  function getCurrentDateString() {
    return new Date().toISOString().split('T')[0];
  }

  function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.style.display = show ? 'flex' : 'none';
    }
  }

  function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    if (toast) {
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }
  }
</script>
</body>
</html>
